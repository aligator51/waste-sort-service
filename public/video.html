<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <title>YOLOv8 — Обработка видео</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin: 24px; }
    .row { display:flex; flex-wrap:wrap; gap:16px; align-items:flex-end; }
    label { display:block; margin:8px 0 4px; font-weight:600; }
    input[type="number"], input[type="text"], input[type="file"], select { padding:8px; min-width: 200px; }
    button { padding:10px 16px; font-weight:600; cursor:pointer; }
    .muted { color:#666; }
    #log { white-space:pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; background:#f6f8fa; padding:12px; border-radius:8px; }
    #player { width: min(960px, 100%); margin-top:16px; background:#000; }
    progress { width: 320px; height: 8px; }
  </style>
</head>
<body>
  <h1>YOLOv8 — обработка видео</h1>
  <p class="muted">Загрузите видео → сервер вернёт размеченный MP4, который сразу проиграется ниже.</p>

  <div class="row">
    <div>
      <label for="file">Видео (MP4/AVI/MOV)</label>
      <input id="file" type="file" accept="video/*" />
    </div>
    <div>
      <label for="conf">conf</label>
      <input id="conf" type="number" step="0.01" min="0" max="1" value="0.25" />
    </div>
    <div>
      <label for="iou">iou</label>
      <input id="iou" type="number" step="0.01" min="0" max="1" value="0.7" />
    </div>
    <div>
      <label for="imgsz">imgsz</label>
      <select id="imgsz">
        <option>640</option>
        <option>512</option>
        <option>416</option>
        <option>320</option>
      </select>
    </div>
    <div>
      <label for="max_frames">max_frames <span class="muted">(демо)</span></label>
      <input id="max_frames" type="number" min="0" value="0" />
    </div>
    <div>
      <label for="model">model (опц.)</label>
      <input id="model" type="text" placeholder="путь к .pt, если нужен" />
    </div>
    <div>
      <button id="run">Запустить</button>
    </div>
  </div>

  <div style="margin-top:12px">
    <progress id="prog" max="100" value="0" hidden></progress>
    <span id="status" class="muted"></span>
  </div>

  <video id="player" controls></video>

  <h3>Лог</h3>
  <div id="log"></div>

  <script>
    const $ = (s) => document.querySelector(s);
    const log = (m) => { $("#log").textContent = (new Date()).toLocaleTimeString() + "  " + m + "\n" + $("#log").textContent; };

    $("#run").addEventListener("click", async () => {
      const file = $("#file").files[0];
      if (!file) { alert("Выберите видеофайл"); return; }

      const conf = $("#conf").value;
      const iou = $("#iou").value;
      const imgsz = $("#imgsz").value;
      const max_frames = $("#max_frames").value || 0;
      const model = $("#model").value;

      const fd = new FormData();
      fd.append("video", file);
      fd.append("conf", conf);
      fd.append("iou", iou);
      fd.append("imgsz", imgsz);
      fd.append("model", model);
      fd.append("max_frames", max_frames);

      $("#prog").hidden = false; $("#prog").value = 10;
      $("#status").textContent = "Обработка...";

      try {
        const resp = await fetch("/api/yolo/video", { method: "POST", body: fd });
        if (!resp.ok) throw new Error("HTTP " + resp.status);
        // получаем mp4 как blob и назначаем источником <video>
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        $("#player").src = url;
        $("#prog").value = 100;
        $("#status").textContent = "Готово";
        log(`Готово: ${file.name}, size ${Math.round(blob.size/1024/1024*10)/10} MB`);
      } catch (e) {
        $("#status").textContent = "Ошибка";
        log("Ошибка: " + e.message);
        console.error(e);
      } finally {
        $("#prog").hidden = true;
      }
    });
  </script>
</body>
</html>
